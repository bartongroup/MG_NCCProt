---
title: "Nascent Chromatin Capture Proteomics"
author:
  - name: Marek Gierlinski
    affiliations: Data Analysis Group
    note: "Creator of this report"
  - name: Susanne Bandau
    affiliation: Molecular Cell and Developmental Biology
  - name: Constance Alabert
    affiliation: Molecular Cell and Developmental Biology
date: today
date-format: "D MMMM YYYY"
execute:
  echo: false
  cache: true
  warning: false
format:
  html:
    theme:
      - journal
      - report.scss
    toc: true
editor: source
self-contained: true
---

```{r libraries, cache=FALSE, include=FALSE}
suppressPackageStartupMessages({
  library(targets)
  library(tidyverse)
  library(gt)
  library(cowplot)
  library(UpSetR)
})

tar_config_set(store = "../_targets")
```

# Proposal

## Background

DNA replication results in the transient eviction of chromatin associated proteins including nucleosomes, RNAPII and transcription regulators. In Constance lab, we are studying, the re-association of chromatin factors after the passage of the replication fork (restoration of chromatin). It has been shown that transcription plays a role to promote chromatin accessibility during restoration on newly replicated DNA (Stewart-Morgan 2019, Ramachandran 2016) and regulates the stable association of several proteins to chromatin (Skalska et al. 2021).
 
The aim of this project is to define the role of transcription restart in chromatin restoration following the passage of the fork. We performed iPOND (isolation of proteins on nascent DNA, Sirbu et al., 2012) experiments in asynchronized, primary like TIG-3 cells (see schematic below) to systematically analyse the protein re-association dynamics to newly replicated DNA upon transcription inhibition via quantitative mass spectrometry.
Two transcription inhibitors were used: Triptolide which blocks RNAPII binding and DRB that blocks transcription elongation. The cells were labelled with EdU for 20min (which is a thymidine analogue and is incorporated into newly replicated DNA) and the proteins associated with the newly replicated (EdU labelled) chromatin were analysed after 20min (nascent), 1h or 2h after the passage of the replication fork (Experiment 1). For the 1h and 2h time points, the EdU is removed after 20min, the cells washed and grown for the remaining time in media containing a low concentration of thymidine to outcompete the remaining EdU in the cells. For each time point, 100 million cells (10x 15cm plates) were harvested allowing the EdU-labelling of around 20-25% of the cells that are in S-phase. To allow the isolation of EdU labelled chromatin using Streptavidin beads, Biotin is associated to EdU via a ClickIT reaction. The lysate input samples represent total cell lysates and were taken before adding the streptavidin beads.
In general, we want to identify factors/functional groups that are changing (or are unchanged) on newly replicated chromatin upon transcription inhibition compared to the control cells. There are some proteins which can be seen as controls for the analysis. The isolation of newly replicated DNA was successful when known replication factors (PCNA, POLD1-3, PRIM1, PRIN2, MCM2-7, GINS1, GINS3, RFC1-5) are enriched on nascent chromatin compared to the later time points. In contrast, the Histone H1 subunits should be low on nascent chromatin but high in the 1h and 2h time points, since Histone H1 is part of the higher-order chromatin structure. For the successful treatment with triptolide, we would expect low level of RNA Polymerase II subunits (POLR2A,B,Câ€¦) on chromatin as well as total lysate (inputs) since triptolide leads to the removal of RNA polymerase II from chromatin and to its subsequential degradation.
 
In experiment 2, we analyse the protein content of restored chromatin after 2h or 6h transcription inhibition to recapitulate whether changes observed on newly replicated chromatin are also seen on total (fully restored) chromatin or whether they are specific to newly replicated chromatin. To capture the protein content of longer stretches of chromatin, the EdU labelling was performed for 1h (instead of 20min).


```{r}
#| label: fig-workflow
#| fig-cap: iPOND workflow.
knitr::include_graphics("images/workflow.png")
```

## Experiment

We have two different experiments that we would like to analyse (all proteomics data):

1.  iPOND experiment: This is the experiment that we discussed during our meeting. We isolated nascent, 1h and 2h chromatin -/+ inhibitor treatment as well as took the corresponding total extracts for each sample before adding the beads to analyse total protein amounts (Input). Since we use two different inhibitors (TPL or DRB), we have 9 sample + 1 negative control (unlabelled) for IP as well as 10 Input samples per experiment; n=3(4)

2.  IPOND chase experiments: 6 sample + control (per experiments); n=3 Instead of isolating nascent chromatin, we analyse the chromatin 24h after labelling. This experiment is to consolidate whether the changes seen on nascent chromatin (iPOND experiment) are also seen on total chromatin.

In both cases, we would like to identify proteins/protein groups that show significant foldchanges between time points and treatment (volcano plots). Filter for the significant changing proteins and subject them to a hierarchical clustering analysis as well as to perform GO term analysis.

The Input samples are total lysate and are used to see whether changes observed on newly replicated chromatin are due to changes in total protein level. The inhibitor that we are using are transcription inhibitor and even the treatment is short might affect the expression of certain proteins.
 
The negative controls are cells that are not labelled with EdU and are used to account for non-specific binding to the streptavidin beads that we are using for the pulldown. To perform the pulldown, we are performing a Click-IT reaction to attach Biotin onto EdU. The Biotin attached to the EdU then allows us to pulldown EdU labelled chromatin using streptavidin beads. The non-specific binding during an iPOND experiments can be high.
I normally harvest them together with the 2h time point but since they are unlabelled, untreated, asynchronized cells, the time they are harvest is not that important.

# Design

@fig-design-e1 and @fig-design-e2 illustrate the design of experiments 1 and 2, respectively.


```{r}
#| label: fig-design-e1
#| fig-cap: Illustration of experiment 1 design.
knitr::include_graphics("images/design_1.png")
```

```{r}
#| label: fig-design-e2
#| fig-cap: Illustration of experiment 2 design.
knitr::include_graphics("images/design_2.png")
```

@tbl-metadata shows the detailed design of the experiment.

```{r}
#| label: tbl-metadata
#| tbl-cap: Design of the experiment. Colour-shaded rows indicate grouping by experiment (E1, E2) and protocol (IP, input).
tar_load(metadata) 
metadata |> 
  select(-c(bad, group, tmt_tag)) |> 
  group_by(experiment, protocol) |> 
  gt() |> 
  sub_missing(missing_text = "") |> 
  tab_options(row_group.background.color = "#FFEFDB")
```


# Data overview

MS-MS proteomics data were processed with *MaxQuant* software at Lamond Lab at SLS.

## Source and filtering

Three `proteinGroups` files were used as the starting point. Data were filtered to remove reverse sequences and potential contaminants. Also, only proteins with at least 3 razor pepties were kept.

## Normalisation

Protein intensities were log-transformed (to base 10) and normalised to the median of each sample.

## Protein detection

@fig-protein-detection shows counts of proteins detected in each sample in each experiment. As expected, input protocol returned more proteins than IP.


```{r}
#| label: fig-protein-detection
#| fig-cap: Number of detected proteins in each sample. Panels A, B and C show Experiment 1 IP, Experiment 1 input and Experiment 2 IP, respectively.
#| fig-width: 8
#| fig-height: 12
g1 <- tar_read(fig_sample_detection_e1_ip)
g2 <- tar_read(fig_sample_detection_e1_input)
g3 <- tar_read(fig_sample_detection_e2_ip)
plot_grid(g1, g2, g3, ncol = 1, labels = c("A", "B", "C"))
```

## Correlation matrix

@fig-cormat shows Pearson's correlation coefficient for all pairs of samples. The checkered-flag pattern indicates strong batch effects.

```{r}
#| label: fig-cormat
#| fig-cap: Correlation matrix for all samples. Panels A, B and C show Experiment 1 IP, Experiment 1 input and Experiment 2 IP, respectively.
#| fig-width: 6
#| fig-height: 20
g1 <- tar_read(fig_matrix_e1_ip)
g2 <- tar_read(fig_matrix_e1_input)
g3 <- tar_read(fig_matrix_e2_ip)
plot_grid(g1, g2, g3, ncol = 1, labels = c("A", "B", "C")) 

```

## PCA

@fig-pca shows first two principal components. The input protocol (panel B) shows strong batch effect - the three groups of points belong to three batches (replicates).


```{r}
#| label: fig-pca
#| fig-cap: PCA decomposition based on logarithm of normalised intensity. Panels A, B and C show Experiment 1 IP, Experiment 1 input and Experiment 2 IP, respectively.
#| fig-width: 6
#| fig-height: 14
g1 <- tar_read(fig_pca_e1_ip)
g2 <- tar_read(fig_pca_e1_input)
g3 <- tar_read(fig_pca_e2_ip)
plot_grid(g1, g2, g3, ncol = 1, labels = c("A", "B", "C")) 
```

## Clustering

@fig-clustering shows clustering of all samples. Colours represent batches. We can see that batch effects dominate this experiment. Hierarchical clustering was calculated using Euclidean distance and complete linkage method.

```{r}
#| label: fig-clustering
#| fig-cap: Dendrogram of samples, based on logarithm of normalised intensity, with Euclidean distance and complete linkage method. Panels A, B and C show Experiment 1 IP, Experiment 1 input and Experiment 2 IP, respectively.
#| fig-width: 8
#| fig-height: 18
g1 <- tar_read(fig_clustering_e1_ip)
g2 <- tar_read(fig_clustering_e1_input)
g3 <- tar_read(fig_clustering_e2_ip)
plot_grid(g1, g2, g3, ncol = 1, labels = c("A", "B", "C"), rel_heights = c(3, 3, 2)) 
```


# Experiment 1 IP

## Differential abundance

### From limma R vignette

*For differential abundance we use `limma`. It used an empirical Bayes method to squeeze the peptide-wise residual variances towards a common value (or towards a global trend) (Smyth, 2004; Phipson et al, 2016). The degrees of freedom for the individual variances are increased to reflect the extra information gained from the empirical Bayes moderation, resulting in increased statistical power to detect differential expression.*

For more information see [Ritchie et al. 2015](https://academic.oup.com/nar/article/43/7/e47/2414268).

### In simpler words

`limma` uses a t-test, which is moderated by borrowing data across all proteins. A global variance model is built and moderation squeezes variances towards this global trend. Extreme variances (either large or small) become less extreme, which makes the test more robust to random outliers.

## Full model

First, we analyse all data using a 'full' model taking into account all potential effects:

`~ treatment + time_point + batch`

This approach assumes that effects of treatment and time point are independent and additive. The model will infer the effect of treatment, time point and batch from all data in experiment 1 (except for negative samples which were removed for this analysis).

The differential abundance is calculated with respect to the baseline:

-   treatment = DMSO
-   time_point = Nascent
-   batch = B1

@fig-da-full shows volcano and MA plots for each of the coefficients. Each panel corresponds to one value of one coefficient, showing differential abundance with respect to the baseline. For example, `treatmentDRB` shows the effect of DRB inferred from all samples in experiment 1.

```{r}
#| label: fig-da-full
#| fig-cap: Differential abundance plots of the full model `~ treatment + time_point + batch`. Black points indicate proteins with significant differential abundance, defined as FDR < 0.01 and |logFC| > 1. A. Volcano plot. B. MA plot.
#| fig-width: 8
#| fig-height: 12
f <- tar_read(figs_full_e1_ip)
plot_grid(f$volcano, f$ma, labels = c("A", "B"), ncol = 1)
```

### Differentially abundant proteins

We see that batch effects are much larger (both in effect size in number of significantly changing proteins) than the effects of treatment and time point. In particular, both treatments (DRB and TPL) result in only small changes in protein intensity with only a few log2-fold changes greater than 1 (that i, more than a two-fold change). @fig-prots-da-full show all proteins changing significantly for treatments DRB and TPL.


```{r}
#| label: fig-prots-da-full
#| fig-cap: Normalised log-abundance of proteins significantly changing for treatment DRB (A) and TPL (B). Please note strong batch effects.
#| fig-width: 8
#| fig-height: 11
g1 <- tar_read(fig_prots_da_full_drb_e1_ip)
g2 <- tar_read(fig_prots_da_full_tpl_e1_ip)
plot_grid(g1, g2, labels = c("A", "B"), ncol = 1) 
```

### Removing DA input

Note that @fig-prots-da-full shows all proteins changing in IP, but some of them are also differentially abundant in the Input (see @fig-prots-da-input-full). When input-changing proteins are removed, we are only left with the following:

 - DRB: `r tar_read(da_genes_ip_only_drb) |> sort()`
 - TPL: `r tar_read(da_genes_ip_only_tpl) |> sort()`


## Selected contrasts

Next, selected contrasts, or pairs of conditions, were selected and differential abundance was carried out. @fig-da-contrasts shows volcano and MA plots for each contrast. There are far fewer proteins changes detected, because batch effects are not taken into account in this simple two-condition differential abundance. The only significant protein in TPL_nas vs DMSO_nas is POLR2A.

```{r}
#| label: fig-da-contrasts
#| fig-cap: Differential abundance for a selection of contrasts. Black points indicate proteins with significant differential abundance, defined as FDR < 0.01 and |logFC| > 1. A. Volcano plot. B. MA plot.
#| fig-width: 8
#| fig-height: 12
f <- tar_read(figs_contrasts_e1_ip)
plot_grid(f$volcano, f$ma, labels = c("A", "B"), ncol = 1)
```

# Experiment 1 Input

## Full model

Just as the IP, input shows strong batch effects. Volcano and MA plots are shown in @fig-da-input-full.

```{r}
#| label: fig-da-input-full
#| fig-cap: Differential abundance plots of the full model `~ treatment + time_point + batch`. Black points indicate proteins with significant differential abundance, defined as FDR < 0.01 and |logFC| > 1. A. Volcano plot. B. MA plot.
#| fig-width: 8
#| fig-height: 12
f <- tar_read(figs_full_e1_input)
plot_grid(f$volcano, f$ma, labels = c("A", "B"), ncol = 1)
```

@fig-prots-da-input-full shows proteins changing in the Input due to treatments.

```{r}
#| label: fig-prots-da-input-full
#| fig-cap: Normalised log-abundance of proteins significantly changing for treatment DRB (A) and TPL (B). Please note strong batch effects.
#| fig-width: 8
#| fig-height: 11
g1 <- tar_read(fig_prots_da_full_drb_e1_input)
g2 <- tar_read(fig_prots_da_full_tpl_e1_input)
plot_grid(g1, g2, labels = c("A", "B"), ncol = 1)
```



# Experiment 2 IP


## Full model

First, we analyse all data using a 'full' model taking into account all potential effects:

`~ treatment + time_point + batch`

This approach assumes that effects of treatment and time point are independent and additive. The model will infer the effect of treatment, time point and batch from all data in experiment 1 (except for negative samples which were removed for this analysis).

The differential abundance is calculated with respect to the baseline:

-   treatment = DMSO
-   time_point = 2h
-   batch = B1

@fig-da-full-e2 shows volcano and MA plots for each of the coefficients. Each panel corresponds to one value of one coefficient, showing differential abundance with respect to the baseline. For example, `treatmentDRB` shows the effect of DRB inferred from all samples in experiment 1.

```{r}
#| label: fig-da-full-e2
#| fig-cap: Differential abundance plots of the full model `~ treatment + time_point + batch`. Black points indicate proteins with significant differential abundance, defined as FDR < 0.01 and |logFC| > 1. A. Volcano plot. B. MA plot.
#| fig-width: 8
#| fig-height: 12
f <- tar_read(figs_full_e2_ip)
plot_grid(f$volcano, f$ma, labels = c("A", "B"), ncol = 1)
```

### Differentially abundant proteins

There are no differentially abundant proteins in DRB. @fig-prots-da-full-e2 shows DA proteins for TPL.

```{r}
#| label: fig-prots-da-full-e2
#| fig-cap: Normalised log-abundance of proteins significantly changing for treatment TPL.
#| fig-width: 8
#| fig-height: 30
g1 <- tar_read(fig_prots_da_full_drb_e2_ip)
g2 <- tar_read(fig_prots_da_full_tpl_e2_ip) 
#plot_grid(g1, g2, labels = c("A", "B"), ncol = 1)
g2
```


# Per batch ratios

There are strong batch effects in our data. Each batch was a separate MS-MS run, therefore, we expect less condition-to-condition variability within each batch than between batches. Therefore, we can attempt using within-batch condition ratios.

Consider one protein and two conditions: TPL-nas and DMSO-nas. Each of the conditions is in three replicates, where replicates 1 come from batch one, replicates 2 come from batch 2 and replicates 3 come from batch 3. Instead of testing three independent replicates in TPL vs DMSO, we can pair them. One way of achieving such pairing can be finding log-ratios between the conditions in each batch. We define the log-ratio

$$
R_{bi} = \log_2 \left( \frac{I_{bi,TPL}}{I_{bi,DMSO}} \right),
$$

for each batch $b$ and protein $i$. Here, $I_{bi}$ is the median-normalised intensity. $R_{bi}$ should a normally distributed variable centred at zero. Large positive $R_{bi}$ indicate up-regulation of the gene $i$ from DMSO to TPL, large negatives the opposite. For a given protein $i$ we have three log-ratios, one for each batch/replicate. We can then use these data to test the up- or down-regulation of the protein with respect to the null hypothesis of $R_{i} = 0$.

Log-ratios were quantile-normalised below further analysis.

## Experiment 1 IP

@fig-dl-e1-ip shows results for experiment 1 IP and a selection of contrasts.

```{r}
#| label: fig-dl-e1-ip
#| fig-cap: Differential abundance plots of the log-ratio data for the selected contrasts for experiment 1 IP. Black points indicate proteins with significant differential abundance, defined as FDR < 0.01 and |logFC| > 1.
#| fig-width: 8
#| fig-height: 5
f <- tar_read(figs_dl_e1_ip)
f$volcano
```

### Differentially abundant proteins

@fig-prots-dl show all proteins changing significantly for DRB_nas-DMSO-nas. Please note that the adjusted p-values for these proteins are all ~0.046, so we have very weak evidence for them.


```{r}
#| label: fig-prots-dl
#| fig-cap: Normalised log-abundance of proteins significantly changing for treatment DRB
#| fig-width: 8
#| fig-height: 5
tar_read(fig_prots_dl_drb_e1_ip)
```

## Experiment 2 IP

@fig-dl-e2-ip shows that in experiment 2, there is a sizeable group of proteins changing between DRB and DMSO at 6h.

```{r}
#| label: fig-dl-e2-ip
#| fig-cap: Differential abundance plots of the log-ratio data for the selected contrasts for experiment 2 IP. Black points indicate proteins with significant differential abundance, defined as FDR < 0.01 and |logFC| > 1.
#| fig-width: 5.3
#| fig-height: 5
f <- tar_read(figs_dl_e2_ip)
f$volcano
```

# Conclusions

Each of the three experiments (E1 IP, E1 Input and E2 IP) was carried out in three mass spectrometer runs, which led to three batches per experiment. This design came from the limitations of TMT spectroscopy that allows for 10 samples multiplexed together. The observed batch effects overshadowed both the time and treatment effects. Specifically, the magnitude of effects from treatments was significantly smaller than those from the batches. This rendered the identification of differentially abundant proteins due to treatment challenging. Furthermore, the presence of only a single replicate within each batch made estimation of within-batch variance impossible.

The full model identified a handful of proteins that exhibited significant changes in response to treatments. However, these findings are derived from the analysis of all data, and were thus influenced by nascent samples, as well as samples from the 1 and 2-hour time points, while the primary biological question was about treatment effects in nascent DNA. Conversely, the contrast-based approach centred on the nascent time point (other contrasts were analysed for comparison). This method compromised statistical power due to a reduced data pool and an inability to disentangle batch effects. An alternative strategy, which involved computing log-ratios for treatments in each batch, found several proteins with significant changes. Yet, the evidence supporting these findings is tenuous, with p-values close to 0.05.


Perhaps a different experimental design should be considered. Rather than attempting to encompass multiple treatments, time points, IP, input and negative controls, a simpler approach could prove more beneficial. With the capacity of a 10-plex TMT, a potential design could allocate one MS run to accommodate 5 DRB and 5 DMSO replicates, and another MS run for 5 TPL and 5 DMSO replicates. This would likely circumvent batch effects and improve statistical power of the experiment.


# Resources

## Downloads


```{r downloads}
#| label: tbl-downloads
#| tbl-cap: tabulated results from differential abundance.
dwn <- "https://www.compbio.dundee.ac.uk/user/mgierlinski/ncc_prot/tab"
subs <- tribble(
  ~name, ~prefix,
  "Full model", "da_full",
  "Selected contrasts", "da_contrasts",
  "Log ratios", "dl"
)
exps <- tribble(
  ~exp_name, ~suffix,
  "E1 IP", "e1_ip",
  "E1 Input", "e1_input",
  "E2 IP", "e2_ip"
)

expand_grid(subs, exps) |> 
  mutate(
    url = file.path(dwn, str_glue("{prefix}_{suffix}.csv")),
    link = map(url, ~ htmltools::a(href = .x, "CSV")),
    link = map(link, ~ gt::html(as.character(.x)))
  ) |> 
  select(model = name, experiment = exp_name, link) |> 
  group_by(model) |> 
  gt() |> 
  tab_options(row_group.background.color = "#FFEFDB")
```


## Code

The code used to create this report is available on [GitHub](https://github.com/bartongroup/MG_NCCProt).


# Session info

```{r}
#| label: session-info
#| cache: false
si <- targets::tar_read(session_info)
si$loadedOnly <- NULL
si
```
